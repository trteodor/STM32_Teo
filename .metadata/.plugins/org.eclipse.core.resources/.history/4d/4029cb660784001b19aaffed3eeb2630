/*
 * LL_UART_TEO.c
 *
 *  Created on: Mar 2, 2021
 *      Author: Teodor
 */
#include "main.h"
#include "stdio.h"
#include "LL_UART_TEO.h"



void Print_Data();
void Teo_SysTick_CallBack();
void  TUART_CallBack_IRQ(UART_Handle_Td *USARTx);
void StartReception(void);
void HandleEcho(UART_Handle_Td *USARTx, uint32_t SendTime);
void USART_TXEmpty_Callback(UART_Handle_Td *USARTx);
void USART_CharTransmitComplete_Callback(UART_Handle_Td *USARTx);


void InitEcho(UART_Handle_Td *USARTx)
{
  LL_USART_ClearFlag_ORE(USARTx->Instance);
  LL_USART_EnableIT_RXNE(USARTx->Instance);
  LL_USART_EnableIT_ERROR(USARTx->Instance);
}

int HandleEcho(UART_Handle_Td *USARTx, uint32_t SendTime)
{
	if(USARTx->RxXferCount!=0)
	{
		USARTx->RecSomething=true;
	}
	if(USARTx->RxXferCount!=USARTx->RxXPrevferCount)
	{
		USARTx->RxXPrevferCount= USARTx->RxXferCount ;
		USARTx->zT=HAL_GetTick();
	}
	if( (USARTx->zT + USARTx->RecTimeout  < HAL_GetTick() )  && USARTx->RecSomething )
	{
		USARTx->RecSomething=false;
		USARTx->zT=HAL_GetTick();
			 for(int i=0; i<USARTx->TxXferSize; i++)
			 {
				 USARTx->pTxBuffPtr[i]=0;
			 }
			 USARTx->RxXferCount=0;
			 USARTx->TxXferCount=sprintf(  (char*)  USARTx->pTxBuffPtr ,"Otrzymano:%s \r", USARTx->pRxBuffPtr);
			 for(int i=0; i< (USARTx->RxXferSize) ; i++)
			 {
				 USARTx->pRxBuffPtr[i]=0;
			 }
			 Print_Data(USARTx);
			 return 1;
	}
	return 0;
}
void USART_CharReception_Callback(UART_Handle_Td *USARTx)
{
	USARTx->pRxBuffPtr[USARTx->RxXferCount++] = LL_USART_ReceiveData8(USARTx->Instance);
}
void Print_Data(UART_Handle_Td *USARTx)
{
    LL_USART_TransmitData8(USARTx->Instance, USARTx->pTxBuffPtr[ USARTx->TxXSendCount++ ]);

        LL_USART_EnableIT_TXE(USARTx->Instance);
    	LL_USART_EnableIT_TC(USARTx->Instance);
}
void USART_TXEmpty_Callback(UART_Handle_Td *USARTx)
{
  if( USARTx->TxXSendCount == ( USARTx->TxXferCount - 1))
  {

    LL_USART_DisableIT_TXE(USARTx->Instance);

    LL_USART_EnableIT_TC(USARTx->Instance);
  }
  LL_USART_TransmitData8(USARTx->Instance, USARTx->pTxBuffPtr[ USARTx->TxXSendCount++ ]);
}
void USART_CharTransmitComplete_Callback(UART_Handle_Td *USARTx)
{
  if(USARTx->TxXSendCount == USARTx->TxXferCount)
  {
	  USARTx->TxXSendCount=0;
  }
}
void TUART_CallBack_IRQ(UART_Handle_Td *USARTx)
{
	 if(LL_USART_IsActiveFlag_RXNE(USARTx->Instance) && LL_USART_IsEnabledIT_RXNE(USARTx->Instance))
		  {
		    USART_CharReception_Callback(USARTx);
		  }

		  if(LL_USART_IsEnabledIT_TXE(USARTx->Instance) && LL_USART_IsActiveFlag_TXE(USARTx->Instance))
		  {
		    USART_TXEmpty_Callback(USARTx);
		  }
		  if(LL_USART_IsEnabledIT_TC(USARTx->Instance) && LL_USART_IsActiveFlag_TC(USARTx->Instance))
		  {
		    LL_USART_ClearFlag_TC(USARTx->Instance);
		    USART_CharTransmitComplete_Callback(USARTx);
		  }
}

